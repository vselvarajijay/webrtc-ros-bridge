# Global docker-compose: app-server, ros2-app-bridge, ros2_bridge (ROS2 nodes), frodobots.
# Run from repo root: docker-compose up -d
#
# ROS2 nodes (in ros2_bridge):
#   - frodobots_bridge: WebRTC -> /robot/video/front, /robot/video/rear, /robot/telemetry, /robot/control
#   - occupancy_node:   /robot/video/front -> /occupancy/annotated_image, /occupancy/grid (floor segmentation + BEV)
# ros2_bridge uses SDK_URL to reach frodobots; ros2_app_bridge subscribes to video + occupancy topics and POSTs to app_server.

services:
  app_server:
    build:
      context: ./app-server
      dockerfile: Dockerfile
    container_name: app_server
    image: app-server:latest
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - ROS2_APP_BRIDGE_URL=http://ros2_app_bridge:9000
      # FRODOBOTS_URL removed - using WebRTC via ROS2 path only
    depends_on:
      - frodobots
    mem_limit: 2g
    mem_reservation: 512m
    networks:
      - webrtc_ros_network

  ros2_app_bridge:
    build:
      context: ./ros2-app-bridge
      dockerfile: Dockerfile
    container_name: ros2_app_bridge
    image: ros2-app-bridge:latest
    ports:
      - "9000:9000"
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - APP_SERVER_URL=http://app_server:8001
      - CONTROL_PORT=9000
    depends_on:
      - app_server
    networks:
      - webrtc_ros_network

  # ROS2 Humble container: runs frodobots_bridge + occupancy_node (occupancy_system.launch.py).
  # Depth panel: run with enable_depth_viz:=true or use_depth_for_occupancy:=true (requires DA3 in image).
  # Rebuild after adding ROS2 packages: docker-compose build ros2_bridge
  ros2_bridge:
    build:
      context: ./ros2_ws
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    container_name: ros2_bridge
    image: ros2-webrtc-bridge:latest
    platform: linux/amd64
    volumes:
      - ./ros2_ws/src:/workspace/src:rw
      # Do not mount install: use the install built in the image so sdk_bridge_core_interfaces and correct Python imports are used
      - ./ros2_ws/log:/workspace/log:rw
      - ./ros2_ws/scripts:/workspace/scripts:ro
    ports:
      - "8080:8080"
      - "11311:11311"
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastrtps_cpp}
      - SDK_URL=${SDK_URL:-http://frodobots:8000}
      - WEBRTC_SIGNALING_PORT=8080
    depends_on:
      - frodobots
    stdin_open: true
    tty: true
    # occupancy_system.launch.py starts: frodobots_bridge (video/telemetry/control) + occupancy_node (floor grid, BEV)
    command: >
      bash -c "source /opt/ros/humble/setup.bash
      && source /workspace/install/setup.bash
      && ros2 launch frodobots_bridge occupancy_system.launch.py
      sdk_url:=http://frodobots:8000
      enable_depth_viz:=true"
    networks:
      - webrtc_ros_network

  frodobots:
    build:
      context: ./frodobots-earth-rovers
      dockerfile: Dockerfile
    container_name: frodobots
    image: frodobots-earth-rovers:latest
    env_file:
      - ./frodobots-earth-rovers/.env
    ports:
      - "8002:8000"   # Host 8002 to avoid conflict with other services on 8000
    environment:
      # SDK_API_TOKEN and BOT_SLUG are loaded from env_file (.env)
      # Override defaults for other variables if needed
      - MISSION_SLUG=${MISSION_SLUG:-}
      - CHROME_EXECUTABLE_PATH=/usr/bin/chromium
      - MAP_ZOOM_LEVEL=${MAP_ZOOM_LEVEL:-18}
      - IMAGE_FORMAT=${IMAGE_FORMAT:-png}
      - IMAGE_QUALITY=${IMAGE_QUALITY:-1.0}
      - DEBUG=${DEBUG:-false}
      - WEBRTC_BRIDGE_URL=${WEBRTC_BRIDGE_URL:-http://ros2_bridge:8080}
    volumes:
      - ./frodobots-earth-rovers/screenshots:/app/screenshots:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - webrtc_ros_network

networks:
  webrtc_ros_network:
    name: webrtc_ros_network
